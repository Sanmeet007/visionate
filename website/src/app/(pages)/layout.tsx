import type { Metadata } from "next";
import AppProgressProvider from "./nprogress";
import { MuiLocalizationProvider } from "../providers/mui-localization-provider";
import { MuiThemeProvider } from "../providers/theme-provider";
import QueryProvider from "../providers/query-provider";
import { UserProvider } from "../providers/user-provider";
import { cookies as requestCookies } from "next/headers";
import { db } from "@/drizzle";
import { sql } from "drizzle-orm";
import { lucia } from "@/auth";

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

const getUser = async () => {
  const cookies = await requestCookies();
  const cookie = cookies.get(lucia.sessionCookieName);

  if (!cookie?.value) return null;

  const { user, session } = await lucia.validateSession(cookie.value);
  if (!session || !user) return null;

  const userData = await db.query.usersTable.findFirst({
    where: sql`id = ${user.id}`,
  });

  if (!userData) return null;

  return JSON.parse(JSON.stringify({ ...userData, hashedPassword: null }));
};

export default async function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  const user = await getUser();

  return (
    <html lang="en">
      <body>
        <UserProvider user={user}>
          <QueryProvider>
            <MuiLocalizationProvider>
              <MuiThemeProvider>
                <AppProgressProvider>{children}</AppProgressProvider>
              </MuiThemeProvider>
            </MuiLocalizationProvider>
          </QueryProvider>
        </UserProvider>
      </body>
    </html>
  );
}
